<html>
<head>
    <meta charset="UTF-8">
    

    <!-- TODO: move in separate file -->
    <script>

    // Table size
    const TABLE_ROWS = 50
    const TABLE_COLUMS = 16

    // Define rows names for create-switches
    const T_CHECKBOX = 0
    const T_SPECIES = 1
    const T_PUBLICATION = 2
    const T_TEMPERATURE = 3
    const T_SALINITY = 4
    const T_DO_LEVEL = 5
    const T_SMR_AVG = 6
    const T_SMR_MIN = 7
    const T_SMR_MAX = 8
    const T_MMR_AVG = 9
    const T_MMR_MIN = 10
    const T_MMR_MAX = 11
    const T_MMR_METHOD = 12
    const T_MASS_AVG = 13
    const T_BR_TEST = 14
    const T_COMMENT = 15
 
    // Dict-container for table data
    var table = {
        // Variable for data from server
        json: {
            values: {count: 0, data: []}, // Parsed values
            deleteUnselected: function() {
                // Remove unselected values
                this.values.data = this.values.data.filter(element => table.checkedRows.includes(element.id))
                this.values.count = this.values.data.lenght
            },
            parse: function (json_data) {
                if(json_data) {
                    // Remove unchecked rows in table
                    this.deleteUnselected()
                    // Parse new data
                    var values = JSON.parse(json_data);
                    // Remove duplicates with old checked data
                    values.data = values.data.filter(element => !table.checkedRows.includes(element.id))
                    // Append new to old values
                    this.values.data = this.values.data.concat(values.data)
                    // Calc new lenght
                    this.values.count = this.values.data.length
                    // Save data
                    sessionStorage.setItem("fishresp_autosave", json_data)
                }
            }
        },
        page: 1, // Current page
        pagesCount: 1, // Pages count
        checkedRows: [], // list contain selected rows by json indexes
        // Update page counter
        pageCouter: function() {
            // Calc pages count
            this.pagesCount = parseInt(this.json.values.count / TABLE_ROWS)
            if (this.json.values.count % TABLE_ROWS > 0)
                this.pagesCount++
            //alert(this.page)
            this.pagesCount = 8
            var pages_counter = document.getElementById('pages_counter')
            pages_counter.innerHTML = ""
            if (this.page > 1)
                pages_counter.innerHTML = "<a onclick='table.selectPage(1)'>1</a>"
            if (this.page > 3)
                pages_counter.innerHTML += "..."
            if ((this.page-1) > 1)
                pages_counter.innerHTML += "<a onclick='table.selectPage("+(this.page-1)+")'>"+(this.page-1)+"</a>"
            pages_counter.innerHTML += "<a style='font-weight:bold;' onclick='table.selectPage("+this.page+")'>"+this.page+"</a>"
            if ((this.page+1) < this.pagesCount)
                pages_counter.innerHTML += "<a onclick='table.selectPage("+(this.page+1)+")'>"+(this.page+1)+"</a>"
            if (this.page+1 < this.pagesCount)
                pages_counter.innerHTML += "..."
            if (this.page != this.pagesCount)
                pages_counter.innerHTML += "<a onclick='table.selectPage("+this.pagesCount+")'>"+this.pagesCount+"</a>"
        },
        // Select page
        selectPage: function(page) {
            this.page = page // Remember the memory page

            // Getting table for filling
            var html_table = document.getElementById("table")
            // Cleanup old data
            while(html_table.hasChildNodes())
                html_table.removeChild(html_table.firstChild);
            
            // Calc current index for selected page
            var curent_index = (this.page-1) * TABLE_ROWS

            // Fill table
            for (row = 0; row < TABLE_ROWS; row++) {
                var current_row = html_table.insertRow(row)
                current_row.className = 'UnselectedRow'
                for (column = 0; column < TABLE_COLUMS; column++) {
                    var current_column = current_row.insertCell(column)
                    if (curent_index < this.json.values.count)
                        current_column.appendChild(this.fill_table_cell(column, row, curent_index))
                }
                curent_index++
            }       
            this.pageCouter() // Update page counter
        },
        // Update table data, when new json received
        update: function(json_data) {
            this.json.parse(json_data) // Parse and store json values
            this.selectPage(1) // Fill first table page  
        },
        // Fill table cell with indexes
        fill_table_cell: function(column, row, curent_index) {
            var object = null
            var html_table = document.getElementById("table")
            // Create object for column
            switch (column) {
                case T_CHECKBOX:
                    object = document.createElement("input");
                    object.type = "checkbox";
                    object.name = row
                    object.value = this.json.values.data[curent_index].id;
                    object.id = "id" + column + "_" + row;
                    // object.name = "name" + json.items[i].name;
                    // On change function
                    object.onchange = function() {
                        if (html_table.children[object.name].className == 'SelectedRow') {
                            // Remove selection color
                            html_table.children[object.name].className = 'UnselectedRow'
                            // Remove row from selected rows list
                            table.checkedRows = table.checkedRows.filter(element => element != object.value)
                        }
                        else {
                            // Set selection color
                            html_table.children[object.name].className = 'SelectedRow'
                            // Add row to selected rows list
                            table.checkedRows.push(object.value)
                        }
                    }
                    
                    // Checking if selecting this row is needed
                    if (table.checkedRows.includes(object.value)) {
                        object.checked = true
                        html_table.children[object.name].className = 'SelectedRow'
                        table.checkedRows.push(object.value)
                    }
                    break
                case T_SPECIES:
                    var value = this.json.values.data[curent_index].Species
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                case T_PUBLICATION:
                    var value = this.json.values.data[curent_index].Publication
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                case T_TEMPERATURE:
                    var value = this.json.values.data[curent_index].Temperature
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                case T_SALINITY:
                    var value = this.json.values.data[curent_index].Salinity
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                case T_DO_LEVEL:
                    var value = this.json.values.data[curent_index].DO_level
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                case T_SMR_AVG:
                    var value = this.json.values.data[curent_index].SMR_avg
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                case T_SMR_MIN:
                    var value = this.json.values.data[curent_index].SMR_min
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                case T_SMR_MAX:
                    var value = this.json.values.data[curent_index].SMR_max
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                case T_MMR_AVG:
                    var value = this.json.values.data[curent_index].MMR_avg
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                case T_MMR_MIN:
                    var value = this.json.values.data[curent_index].MMR_min
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                case T_MMR_MAX:
                    var value = this.json.values.data[curent_index].MMR_max
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                case T_MMR_METHOD:
                    var value = this.json.values.data[curent_index].MMR_method
                    if (value == undefined)
                        value = 'no'
                    object = document.createTextNode(value)
                    break
                case T_MASS_AVG:
                    var value = this.json.values.data[curent_index].Mass_avg
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                case T_BR_TEST:
                    var value = this.json.values.data[curent_index].BR_test
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                case T_COMMENT:
                    var value = this.json.values.data[curent_index].Comment
                    if (value == undefined)
                        value = ''
                    object = document.createTextNode(value)
                    break
                default:
                    object = document.createTextNode("")
            } 
            return object
        }
    }

    // Function to initialize filters and autosave 
    function init() {
        if (sessionStorage.getItem("fishresp_autosave")) {
            // Restore the contents of json data
            table.update(sessionStorage.getItem("fishresp_autosave"))
        }
        else
            // TODO: send request to server for last TABLE_ROWS lines
            table.update() // Gen empty table
    }
    
    // function to block the page while loading
    function switchLock(){
        // Hover for loading data
        let hover = document.getElementById("hover")

        if (hover.style.visibility != "visible")
            hover.style.visibility = "visible"
        else
            hover.style.visibility = "hidden"
    }

    function uploadTestData() {
        // Test data
        var json_text = '\
{\
    "count":2,\
    "data":[\
        {\
            "id":"1",\
            "Species":"fish_1",\
            "Publication":"213/321",\
            "Temperature":24,\
            "Salinity":"0",\
            "DO_level":100,\
            "SMR_avg":120\
        },\
        {\
            "id":"2",\
            "Species":"fish_2",\
            "Publication":"213/321",\
            "Temperature":12,\
            "Salinity":"0",\
            "DO_level":100,\
            "SMR_avg":89,\
            "SMR_min":65,\
            "SMR_max":144,\
            "MMR_avg":163,\
            "MMR_min":159,\
            "MMR_max":354,\
            "MMR_method":"Ucrit",\
            "Mass_avg":20,\
            "BR_test":"yes",\
            "Comment":"Fish 2 comment"\
        }\
    ]\
}\
'
        sessionStorage.setItem("fishresp_autosave", json_text)
        table.update(json_text)

    }
    </script>

    <!-- TODO: move in separate file -->
    <style type="text/css">
        /* Hover for loading data */
        .hover {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            z-index: 1;
            background-color: #50505050;
            visibility: hidden;
        }

        /* Select/unselect rows for widgets */
        .SelectedRow {
            background-color: yellow;
        }
        .UnselectedRow {
            background-color: #fff;
        }
        
        /* Table parameters */
        table, th, td {
            border: 1px solid;
            height: 1rem;
            /* max-width: 50rem; */
            /* TODO: decide on the size */
        }
        /* Disabled cells for unavailable filters */
        td.disabled {
            background-color: gainsboro;
        }
        /* Disable borders for inputs in filters */
        input.Unbordered{
            border: 0px solid;
            max-width: 2.4rem;
        }
      
    </style>
</head>
<body onload="init()">
    <!-- Debug buttons -->
    <button onclick="uploadTestData()">Upload test data</button>
    <button onclick="switchLock()">Enable hover</button>
    <button onclick="table.selectPage(1)">Set page 1</button>
    <button onclick="table.selectPage(2)">Set page 2</button>

    <!-- Table for respirometry -->
    <table>
        <!-- Header with filters -->
        <tbody>
            <tr>
                <td>Select</td>
                <td>Species</td>
                <td>Publication</td>
                <td>Temperature</td>
                <td>Salinity</td>
                <td>DO level</td>
                <td>SMR avg</td>
                <td>SMR min</td>
                <td>SMR max</td>
                <td>MMR avg</td>
                <td>MMR min</td>
                <td>MMR max</td>
                <td>MMR method</td>
                <td>Mass avg</td>
                <td>BR test</td>
                <td>Comment</td>
            </tr>
            <tr>
                <td class="disabled">Filters:</td>
                <td><input class="Unbordered" id="filter_Species" placeholder="Name"></td>
                <td><input class="Unbordered" id="filter_Publication" placeholder="DOI"></td>
                <td><input class="Unbordered" id="filter_Temperature" placeholder="min">-<input class="Unbordered" id="filter_Temperature" placeholder="max"></td>
                <td><input class="Unbordered" id="filter_Salinity" placeholder="min">-<input class="Unbordered" id="filter_Salinity" placeholder="max"></td>
                <td><input class="Unbordered" id="filter_DO level" placeholder="min">-<input class="Unbordered" id="filter_DO level" placeholder="max"></td>
                <td><input class="Unbordered" id="filter_SMR avg" placeholder="min">-<input class="Unbordered" id="filter_SMR avg" placeholder="max"></td>
                <td><input class="Unbordered" id="filter_SMR min" placeholder="min">-<input class="Unbordered" id="filter_SMR min" placeholder="max"></td>
                <td><input class="Unbordered" id="filter_SMR max" placeholder="min">-<input class="Unbordered" id="filter_SMR max" placeholder="max"></td>
                <td><input class="Unbordered" id="filter_MMR avg" placeholder="min">-<input class="Unbordered" id="filter_MMR avg" placeholder="max"></td>
                <td><input class="Unbordered" id="filter_MMR min" placeholder="min">-<input class="Unbordered" id="filter_MMR min" placeholder="max"></td>
                <td><input class="Unbordered" id="filter_MMR max" placeholder="min">-<input class="Unbordered" id="filter_MMR max" placeholder="max"></td>
                <td><input class="Unbordered" id="filter_MMR method" placeholder="min">-<input class="Unbordered" id="filter_MMR method" placeholder="max"></td>
                <td><input class="Unbordered" id="filter_Mass avg" placeholder="min">-<input class="Unbordered" id="filter_Mass avg" placeholder="max"></td>
                <td><input class="Unbordered" id="filter_BR test" placeholder="min">-<input class="Unbordered" id="filter_BR test" placeholder="max"></td>
                <td class="disabled"></td>
            </tr>
        </tbody>

        <!-- Dynamicaly filled rows -->
        <tbody id="table"></tbody>
    </table>
    <!-- Dynamicaly filled pages counter -->
    <div id="pages_counter"></div>
        

    <!-- Hover for loading data -->
    <div id="hover" class="hover"></div>
</body>
</html>